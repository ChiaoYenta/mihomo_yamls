name: Update Configs

on:
  schedule:
    - cron: '30 22 * * *' # UTC 22:30 = åŒ—äº¬æ—¶é—´æ¬¡æ—¥6:30
  workflow_dispatch:
    inputs:
      category:
        description: 'é€‰æ‹©è¦æ›´æ–°çš„ç±»åˆ«'
        required: false
        type: choice
        options:
          - all
          - official
          - general
          - smart
          - mobile
        default: all

permissions:
  contents: write

jobs:
  # ç¬¬ä¸€é˜¶æ®µ: ä¸‹è½½æ‰€æœ‰é…ç½®
  download-configs:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        category:
          - official
          - general
          - smart
          - mobile
      fail-fast: false
      max-parallel: 4
    
    # âŒ åˆ é™¤è¿™é‡Œçš„ ifï¼Œå› ä¸º matrix å˜é‡åœ¨æ­¤å¤„ä¸å¯ç”¨
    
    steps:
      - name: æ£€æŸ¥å­˜å‚¨åº“
        # ğŸ”§ ä¿®æ­£: v6 ä¸å­˜åœ¨ï¼Œæ”¹ä¸º v4
        uses: actions/checkout@v4 
        with:
          ref: ${{ github.ref }}

      # ğŸ’¡ åœ¨è¿™é‡Œæ·»åŠ åˆ¤æ–­é€»è¾‘
      - name: åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡Œ
        id: check_run
        run: |
          should_run=false
          if [[ "${{ github.event_name }}" == "schedule" ]] || \
             [[ "${{ github.event.inputs.category }}" == "all" ]] || \
             [[ "${{ github.event.inputs.category }}" == "${{ matrix.category }}" ]]; then
             should_run=true
          fi
          echo "should_run=$should_run" >> $GITHUB_OUTPUT
          echo "Run status: $should_run"

      - name: ä¸‹è½½é…ç½®æ–‡ä»¶
        id: download
        # âœ… ä»…å½“æ»¡è¶³æ¡ä»¶æ—¶è¿è¡Œ
        if: steps.check_run.outputs.should_run == 'true'
        run: |
          case "${{ matrix.category }}" in
            official)
              echo "ğŸ“¥ ä¸‹è½½å®˜æ–¹ç¤ºä¾‹é…ç½®..."
              mkdir -p "Official_Examples/Metacubex"
              curl -s -o "Official_Examples/Metacubex/rule-set_config.yaml" \
                "https://wiki.metacubex.one/example/mrs"
              curl -s -o "Official_Examples/Metacubex/geox_config.yaml" \
                "https://wiki.metacubex.one/example/geox"
              artifact_path="Official_Examples"
              ;;
            
            general)
              echo "ğŸ“¥ ä¸‹è½½é€šç”¨é…ç½®..."
              # ç¡®ä¿è„šæœ¬å­˜åœ¨ä¸”å¯æ‰§è¡Œï¼Œè¿™é‡Œå‡è®¾ä½ çš„ä»“åº“é‡Œæœ‰è¿™äº›è„šæœ¬
              if [ -f .github/scripts/download-general.sh ]; then
                bash .github/scripts/download-general.sh
              else 
                mkdir -p General_Config # é˜²æ­¢æŠ¥é”™
              fi
              artifact_path="General_Config"
              ;;
            
            smart)
              echo "ğŸ“¥ ä¸‹è½½Smartæ¨¡å¼é…ç½®..."
              if [ -f .github/scripts/download-smart.sh ]; then
                bash .github/scripts/download-smart.sh
              else
                 mkdir -p Smart_Mode
              fi
              artifact_path="Smart_Mode"
              ;;
            
            mobile)
              echo "ğŸ“¥ ä¸‹è½½ç§»åŠ¨æ¨¡å—é…ç½®..."
              if [ -f .github/scripts/download-mobile.sh ]; then
                bash .github/scripts/download-mobile.sh
              else
                 mkdir -p Mobile_Modules
              fi
              artifact_path="Mobile_Modules"
              ;;
          esac
          
          echo "artifact_path=$artifact_path" >> $GITHUB_OUTPUT

      - name: éªŒè¯ä¸‹è½½ç»“æœ
        # âœ… ä»…å½“æ»¡è¶³æ¡ä»¶æ—¶è¿è¡Œ
        if: steps.check_run.outputs.should_run == 'true'
        run: |
          echo "ğŸ” éªŒè¯ ${{ matrix.category }} é…ç½®..."
          
          total=0
          success=0
          failed=0
          
          case "${{ matrix.category }}" in
            official) dir="Official_Examples" ;;
            general) dir="General_Config" ;;
            smart) dir="Smart_Mode" ;;
            mobile) dir="Mobile_Modules" ;;
          esac
          
          if [ -d "$dir" ]; then
            while IFS= read -r -d '' file; do
              total=$((total + 1))
              size=$(wc -c < "$file")
              
              if [ $size -gt 100 ]; then
                success=$((success + 1))
                echo "âœ… ${file}: ${size} bytes"
              else
                failed=$((failed + 1))
                echo "âŒ ${file}: ${size} bytes (too small)"
              fi
            done < <(find "$dir" -type f -name "*.yaml" -print0)
          fi
          
          echo ""
          echo "ğŸ“Š ç»Ÿè®¡ç»“æœ:"
          echo "  æ€»è®¡: $total ä¸ªæ–‡ä»¶"
          echo "  æˆåŠŸ: $success ä¸ªæ–‡ä»¶"
          echo "  å¤±è´¥: $failed ä¸ªæ–‡ä»¶"
          
          if [ $total -gt 0 ] && [ $((failed * 2)) -gt $total ]; then
            echo "âš ï¸  è­¦å‘Š: å¤±è´¥ç‡è¿‡é«˜!"
          fi

      - name: ä¸Šä¼  artifact
        uses: actions/upload-artifact@v4
        # âœ… ä»…å½“æ»¡è¶³æ¡ä»¶ä¸”ä¸Šä¸€æ­¥æˆåŠŸæ—¶è¿è¡Œ
        if: steps.check_run.outputs.should_run == 'true'
        with:
          name: configs-${{ matrix.category }}
          path: ${{ steps.download.outputs.artifact_path }}
          retention-days: 1
          if-no-files-found: ignore # é˜²æ­¢ç©ºæ–‡ä»¶å¤¹æŠ¥é”™

  # ç¬¬äºŒé˜¶æ®µ: åˆå¹¶æ‰€æœ‰é…ç½®å¹¶æäº¤
  commit-changes:
    needs: download-configs
    runs-on: ubuntu-latest
    if: always() 
    
    steps:
      - name: æ£€æŸ¥å­˜å‚¨åº“
        uses: actions/checkout@v4 # ğŸ”§ ä¿®æ­£ä¸º v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0 

      - name: ä¸‹è½½æ‰€æœ‰ artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-configs
          pattern: configs-* # åªä¸‹è½½åŒ¹é…çš„ artifact
          merge-multiple: true # v4 æ–°ç‰¹æ€§ï¼Œè‡ªåŠ¨åˆå¹¶åŒåç›®å½•(å¦‚æœæœ‰)

      - name: åˆå¹¶é…ç½®æ–‡ä»¶
        run: |
          echo "ğŸ“¦ åˆå¹¶é…ç½®æ–‡ä»¶..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹è½½åˆ°æ–‡ä»¶
          if [ -d "downloaded-configs" ]; then
             # å› ä¸ºä½¿ç”¨äº† merge-multiple: true æˆ–é»˜è®¤è¡Œä¸ºï¼Œv4å¯èƒ½ä¼šç›´æ¥æŠŠæ–‡ä»¶è§£å‹åˆ° path
             # ä¸‹é¢çš„é€»è¾‘é€‚é… v4 çš„ç›®å½•ç»“æ„
             
             # å¦‚æœ artifact å¸¦ç€ç›®å½•ç»“æ„ä¸Šä¼ ï¼Œè¿™é‡Œç›´æ¥å¤åˆ¶å³å¯
             cp -r downloaded-configs/* . 2>/dev/null || true
             
             # å¦‚æœ v4 ä¸‹è½½åæ¯ä¸ª artifact æ˜¯ä¸€ä¸ªå­æ–‡ä»¶å¤¹ (é»˜è®¤è¡Œä¸º)
             # configs-official/Official_Examples/...
             for dir in downloaded-configs/*; do
               if [ -d "$dir" ]; then
                 echo "Processing $dir..."
                 cp -r "$dir"/* . 2>/dev/null || true
               fi
             done
          else
             echo "âš ï¸ æ²¡æœ‰ä¸‹è½½åˆ°ä»»ä½•é…ç½® (å¯èƒ½æ˜¯å› ä¸ºåªé€‰æ‹©äº†ç‰¹å®šç±»åˆ«ä¸”æœªç”Ÿæˆ artifact)"
          fi
          
          # æ¸…ç†
          rm -rf downloaded-configs

      - name: ç”Ÿæˆæ›´æ–°æŠ¥å‘Š
        id: report
        run: |
          echo "ğŸ“ ç”Ÿæˆæ›´æ–°æŠ¥å‘Š..."
          
          report="## é…ç½®æ›´æ–°æŠ¥å‘Š - $(date +'%Y-%m-%d %H:%M:%S')"
          report="${report}\n"
          
          for dir in Official_Examples General_Config Smart_Mode Mobile_Modules; do
            if [ -d "$dir" ]; then
              count=$(find "$dir" -type f -name "*.yaml" | wc -l)
              size=$(du -sh "$dir" 2>/dev/null | cut -f1)
              report="${report}\n### ${dir}"
              report="${report}\n- æ–‡ä»¶æ•°é‡: ${count}"
              report="${report}\n- æ€»å¤§å°: ${size}\n"
            fi
          done
          
          echo -e "$report"
          echo -e "$report" > UPDATE_REPORT.md

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        id: check
        run: |
          git diff --quiet || echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        if: steps.check.outputs.has_changes == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add .
          
          echo "ğŸ”„ è‡ªåŠ¨æ›´æ–°é…ç½®æ–‡ä»¶ [$(date +'%Y-%m-%d %H:%M:%S')]" > commit_msg.txt
          echo "" >> commit_msg.txt
          cat UPDATE_REPORT.md >> commit_msg.txt
          
          git commit -F commit_msg.txt
          git push origin HEAD:${{ github.ref_name }}
          
          echo "âœ… æ›´æ”¹å·²æˆåŠŸæ¨é€"

      - name: æ¸…ç†æ—§çš„ artifacts
        if: always()
        uses: geekyeggo/delete-artifact@v2
        with:
          name: configs-*
